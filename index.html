<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Production analytics dashboard" />
  <title>Production Analytics Dashboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://unpkg.com" />
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.8/css/dataTables.tailwindcss.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css"
  />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "media"
    };
  </script>
  <style>
    .ts-wrapper.multi .ts-control {
      max-height: 8.5rem;
      overflow-y: auto;
    }

    .ts-dropdown .ts-dropdown-content {
      max-height: 14rem;
      overflow-y: auto;
    }

    @media (max-width: 640px) {
      .ts-wrapper.multi .ts-control {
        max-height: 7rem;
      }
    }
  </style>
</head>
<body class="min-h-full bg-[#f0f2f5] text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <header class="bg-white dark:bg-slate-900">
    <nav class="max-w-screen-2xl mx-auto px-4 py-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-xl font-semibold text-[#004a99] dark:text-[#76c7ff]">Production Analytics Dashboard</h1>
        <p class="text-sm text-slate-500 dark:text-slate-300">Explore cycle time, labor, and FTE data with quick filters and scenario inputs.</p>
      </div>
    </nav>
    <div class="h-[3px] bg-gradient-to-r from-[#004a99] to-[#76c7ff]"></div>
  </header>

  <main class="max-w-screen-2xl mx-auto px-4 py-6 space-y-6">
    <section class="rounded-2xl bg-white p-6 shadow-lg dark:bg-slate-800" aria-labelledby="scenario-title">
      <div class="grid gap-6 lg:grid-cols-2">
        <div>
          <div class="flex items-center justify-between">
            <h2 id="scenario-title" class="text-lg font-semibold text-slate-900 dark:text-white">Scenario Inputs</h2>
            <button
              id="addScenarioRow"
              type="button"
              class="inline-flex items-center rounded-lg border border-[#004a99] px-3 py-1.5 text-sm font-medium text-[#004a99] transition hover:bg-[#004a99]/10 dark:border-[#76c7ff] dark:text-[#76c7ff]"
              aria-label="Add another machine group"
            >
              Add another machine group
            </button>
          </div>
          <p class="mt-1 text-sm text-slate-500 dark:text-slate-300">Add multiple machine groups to model combined demand scenarios.</p>
          <div id="scenarioRows" class="mt-4 space-y-4"></div>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Upload CSV</h2>
          <label for="csvFile" class="mt-3 block text-sm font-medium text-slate-700 dark:text-slate-200">Replace dataset</label>
          <input
            id="csvFile"
            type="file"
            accept=".csv"
            class="mt-2 block w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-[#76c7ff] focus:outline-none focus:ring-2 focus:ring-[#76c7ff]/50 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200"
          />
          <p class="mt-3 text-xs text-slate-500 dark:text-slate-400">
            Expected columns: Department, MachineType, WorkCenter, TimeApplicable, DatasetName, Unit, Value, CriticalPath.
          </p>
        </div>
      </div>
    </section>

    <section class="rounded-2xl bg-white p-6 shadow-lg dark:bg-slate-800" aria-labelledby="filters-title">
      <details class="group">
        <summary class="flex cursor-pointer items-center justify-between text-lg font-semibold text-slate-900 dark:text-white" id="filters-title">
          Filters
          <span class="text-sm font-medium text-slate-500 transition group-open:rotate-180">â–¾</span>
        </summary>
        <div class="mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div>
            <label for="departmentFilter" class="text-sm font-medium text-slate-700 dark:text-slate-200">Department</label>
            <select id="departmentFilter" multiple aria-label="Filter by department"></select>
          </div>
          <div>
            <label for="machineFilter" class="text-sm font-medium text-slate-700 dark:text-slate-200">Machine Type</label>
            <select id="machineFilter" multiple aria-label="Filter by machine type"></select>
          </div>
          <div>
            <label for="datasetFilter" class="text-sm font-medium text-slate-700 dark:text-slate-200">Dataset Name</label>
            <select id="datasetFilter" multiple aria-label="Filter by dataset name"></select>
          </div>
          <div class="flex items-center">
            <label for="criticalFilter" class="flex items-center gap-3 text-sm font-medium text-slate-700 dark:text-slate-200">
              Only Critical Path
              <span class="relative inline-flex h-6 w-11 items-center">
                <input id="criticalFilter" type="checkbox" class="peer sr-only" aria-label="Only critical path" />
                <span class="h-6 w-11 rounded-full bg-slate-200 transition peer-checked:bg-[#004a99] dark:bg-slate-700"></span>
                <span class="absolute left-1 h-4 w-4 rounded-full bg-white transition peer-checked:translate-x-5"></span>
              </span>
            </label>
          </div>
        </div>
      </details>
    </section>

    <section class="grid gap-4 md:grid-cols-4" aria-label="Key performance indicators">
      <div class="relative rounded-2xl border-l-4 border-[#76c7ff] bg-white p-5 shadow-lg dark:bg-slate-800">
        <div class="absolute right-4 top-4 text-slate-400">
          <i data-lucide="clock" class="h-5 w-5"></i>
        </div>
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Average cycle time (seconds)</h3>
        <p id="kpiCycle" class="mt-2 text-3xl font-semibold text-[#004a99]">0</p>
      </div>
      <div class="relative rounded-2xl border-l-4 border-[#76c7ff] bg-white p-5 shadow-lg dark:bg-slate-800">
        <div class="absolute right-4 top-4 text-slate-400">
          <i data-lucide="activity" class="h-5 w-5"></i>
        </div>
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Total labor hours</h3>
        <p id="kpiLabor" class="mt-2 text-3xl font-semibold text-[#004a99]">0</p>
      </div>
      <div class="relative rounded-2xl border-l-4 border-[#76c7ff] bg-white p-5 shadow-lg dark:bg-slate-800">
        <div class="absolute right-4 top-4 text-slate-400">
          <i data-lucide="users" class="h-5 w-5"></i>
        </div>
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Computed total FTE</h3>
        <p id="kpiFte" class="mt-2 text-3xl font-semibold text-[#004a99]">0</p>
      </div>
      <div class="relative rounded-2xl border-l-4 border-[#76c7ff] bg-white p-5 shadow-lg dark:bg-slate-800">
        <div class="absolute right-4 top-4 text-slate-400">
          <i data-lucide="hash" class="h-5 w-5"></i>
        </div>
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Row count</h3>
        <p id="kpiRows" class="mt-2 text-3xl font-semibold text-[#004a99]">0</p>
      </div>
    </section>

    <div id="kpiAnnouncer" class="sr-only" aria-live="polite"></div>

    <section class="grid gap-4 lg:grid-cols-3" aria-label="Charts">
      <div class="rounded-2xl bg-white p-5 shadow-lg dark:bg-slate-800">
        <h2 class="text-base font-semibold">Average cycle time per Machine Type</h2>
        <div class="mt-4 h-72">
          <canvas id="cycleByMachine" class="h-full w-full"></canvas>
        </div>
      </div>
      <div class="rounded-2xl bg-white p-5 shadow-lg dark:bg-slate-800">
        <h2 class="text-base font-semibold">Labor hours vs FTE per Machine Type</h2>
        <div class="mt-4 h-72">
          <canvas id="laborFteByMachine" class="h-full w-full"></canvas>
        </div>
      </div>
      <div class="rounded-2xl bg-white p-5 shadow-lg dark:bg-slate-800">
        <h2 class="text-base font-semibold">Average cycle time over Time Applicable</h2>
        <div class="mt-4 h-72">
          <canvas id="cycleOverTime" class="h-full w-full"></canvas>
        </div>
      </div>
    </section>

    <section class="rounded-2xl bg-white p-6 shadow-lg dark:bg-slate-800" aria-labelledby="table-title">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <h2 id="table-title" class="text-lg font-semibold">Filtered Data</h2>
        <button
          class="rounded-lg bg-[#004a99] px-4 py-2 text-sm font-medium text-white shadow transition hover:bg-[#003870]"
          id="downloadCsv"
          type="button"
        >
          Download CSV
        </button>
      </div>
      <div class="mt-4 overflow-auto rounded-xl border border-slate-100 dark:border-slate-700">
        <table id="dataTable" class="display stripe hover w-full whitespace-nowrap text-sm">
          <thead class="bg-slate-50 text-left text-xs uppercase text-slate-500 dark:bg-slate-900 dark:text-slate-400">
            <tr id="tableHead"></tr>
          </thead>
          <tfoot class="bg-slate-50 text-left text-xs uppercase text-slate-500 dark:bg-slate-900 dark:text-slate-400">
            <tr id="tableFoot"></tr>
          </tfoot>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="max-w-screen-2xl mx-auto px-4 pb-6 text-xs text-slate-400">
    Updated analytics view with accessible filters and scenario planning tools.
  </footer>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.tailwindcss.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="module">
    const palette = {
      lightBlue: "#76c7ff",
      darkBlue: "#004a99",
      lightGrey: "#f0f2f5",
      lightBlueFill: "rgba(118,199,255,0.7)",
      lightBlueFillSoft: "rgba(118,199,255,0.3)"
    };

    const baselineUnits = 100;
    const baselineMonths = 12;

    const dummyCsv = `Department,MachineType,WorkCenter,TimeApplicable,DatasetName,Unit,Value,CriticalPath,Notes,Shift
Assembly,MT-100,WC-01,2023-Q4,Baseline 2024,Cycle Time,120,Yes,Primary line,Day
Assembly,MT-100,WC-01,2023-Q4,Baseline 2024,Labor Hours,55,Yes,Primary line,Day
Assembly,MT-100,WC-01,2023-Q4,Baseline 2024,FTE,3.2,Yes,Primary line,Day
Assembly,MT-100,WC-01,2024-Q1,Baseline 2024,Cycle Time,115,Yes,Primary line,Day
Assembly,MT-100,WC-01,2024-Q1,Baseline 2024,Labor Hours,52,Yes,Primary line,Day
Paint,PT-200,WC-07,2023-Q4,Baseline 2024,Cycle Time,180,No,Paint booth,Night
Paint,PT-200,WC-07,2023-Q4,Baseline 2024,Labor Hours,60,No,Paint booth,Night
Paint,PT-200,WC-07,2023-Q4,Baseline 2024,FTE,2.6,No,Paint booth,Night
Paint,PT-200,WC-07,2024-Q1,Stretch 2024,Cycle Time,170,No,Paint booth,Night
Paint,PT-200,WC-07,2024-Q1,Stretch 2024,Labor Hours,58,No,Paint booth,Night
Machining,MC-300,WC-05,2023-Q4,Baseline 2024,Cycle Time,210,Yes,CNC cell,Day
Machining,MC-300,WC-05,2023-Q4,Baseline 2024,Labor Hours,70,Yes,CNC cell,Day
Machining,MC-300,WC-05,2023-Q4,Baseline 2024,FTE,3.8,Yes,CNC cell,Day
Machining,MC-300,WC-05,2024-Q1,Stretch 2024,Cycle Time,205,Yes,CNC cell,Day
Machining,MC-300,WC-05,2024-Q1,Stretch 2024,Labor Hours,68,Yes,CNC cell,Day`;

    const state = {
      rawData: [],
      filteredData: [],
      dataTable: null,
      charts: {},
      tomSelects: {}
    };

    const elements = {
      departmentFilter: document.getElementById("departmentFilter"),
      machineFilter: document.getElementById("machineFilter"),
      datasetFilter: document.getElementById("datasetFilter"),
      criticalFilter: document.getElementById("criticalFilter"),
      csvFile: document.getElementById("csvFile"),
      downloadCsv: document.getElementById("downloadCsv"),
      tableHead: document.getElementById("tableHead"),
      tableFoot: document.getElementById("tableFoot"),
      kpiCycle: document.getElementById("kpiCycle"),
      kpiLabor: document.getElementById("kpiLabor"),
      kpiFte: document.getElementById("kpiFte"),
      kpiRows: document.getElementById("kpiRows"),
      kpiAnnouncer: document.getElementById("kpiAnnouncer"),
      scenarioRows: document.getElementById("scenarioRows"),
      addScenarioRow: document.getElementById("addScenarioRow")
    };

    const csvColumns = [
      "Department",
      "MachineType",
      "WorkCenter",
      "TimeApplicable",
      "DatasetName",
      "Unit",
      "Value",
      "CriticalPath",
      "Notes",
      "Shift"
    ];

    const parseCsvAsync = (csvText) =>
      new Promise((resolve, reject) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          worker: true,
          complete: (results) => resolve(results.data),
          error: (error) => reject(error)
        });
      });

    const normalizeRow = (row) => ({
      ...row,
      Value: Number(row.Value) || 0,
      CriticalPath: row.CriticalPath?.trim() || "No"
    });

    const uniqueValues = (data, key) =>
      Array.from(new Set(data.map((row) => row[key]).filter(Boolean))).sort();

    const updateTomSelectOptions = (selectInstance, values) => {
      selectInstance.clearOptions();
      selectInstance.addOptions(values.map((value) => ({ value, text: value })));
      selectInstance.setValue(values, true);
      selectInstance.refreshOptions(false);
    };

    const matchesFilter = (row, filterValues, key) =>
      !filterValues.length || filterValues.includes(row[key]);

    const getScenarioTotals = () => {
      const rows = Array.from(elements.scenarioRows.querySelectorAll(".scenario-row"));
      return rows.reduce(
        (totals, row) => {
          const units = Number(row.querySelector(".scenario-units").value) || 0;
          const months = Number(row.querySelector(".scenario-months").value) || 0;
          return {
            units: totals.units + units,
            months: totals.months + months
          };
        },
        { units: 0, months: 0 }
      );
    };

    const calculateAverage = (values) =>
      values.length ? values.reduce((total, value) => total + value, 0) / values.length : 0;

    const formatNumber = (value, decimals = 1) =>
      Number(value).toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });

    const loadData = async (data) => {
      state.rawData = data.map(normalizeRow);
      updateTomSelectOptions(state.tomSelects.department, uniqueValues(state.rawData, "Department"));
      updateTomSelectOptions(state.tomSelects.machine, uniqueValues(state.rawData, "MachineType"));
      updateTomSelectOptions(state.tomSelects.dataset, uniqueValues(state.rawData, "DatasetName"));
      await refreshDashboard();
    };

    const applyFilters = async () => {
      await new Promise((resolve) => requestAnimationFrame(resolve));
      const selectedDepartments = state.tomSelects.department.items;
      const selectedMachines = state.tomSelects.machine.items;
      const selectedDatasets = state.tomSelects.dataset.items;
      const onlyCritical = elements.criticalFilter.checked;

      state.filteredData = state.rawData.filter((row) => {
        const isCritical = !onlyCritical || row.CriticalPath === "Yes";
        return (
          isCritical &&
          matchesFilter(row, selectedDepartments, "Department") &&
          matchesFilter(row, selectedMachines, "MachineType") &&
          matchesFilter(row, selectedDatasets, "DatasetName")
        );
      });
    };

    const renderKPIs = () => {
      const cycleRows = state.filteredData.filter((row) => row.Unit === "Cycle Time");
      const laborRows = state.filteredData.filter((row) => row.Unit === "Labor Hours");
      const fteRows = state.filteredData.filter((row) => row.Unit === "FTE");

      const avgCycle = calculateAverage(cycleRows.map((row) => row.Value));
      const totalLabor = laborRows.reduce((total, row) => total + row.Value, 0);
      const totalFteBase = fteRows.reduce((total, row) => total + row.Value, 0);

      const scenarioTotals = getScenarioTotals();
      const units = scenarioTotals.units || baselineUnits;
      const months = scenarioTotals.months || baselineMonths;
      const scale = (units / baselineUnits) * (months / baselineMonths);
      const totalFte = totalFteBase * scale;

      elements.kpiCycle.textContent = formatNumber(avgCycle, 1);
      elements.kpiLabor.textContent = formatNumber(totalLabor, 1);
      elements.kpiFte.textContent = formatNumber(totalFte, 2);
      elements.kpiRows.textContent = state.filteredData.length.toLocaleString();

      elements.kpiAnnouncer.textContent = `KPIs updated. Avg cycle time ${formatNumber(
        avgCycle,
        1
      )} seconds, total labor ${formatNumber(totalLabor, 1)} hours, total FTE ${formatNumber(
        totalFte,
        2
      )}, rows ${state.filteredData.length}.`;
    };

    const groupBy = (data, key) =>
      data.reduce((acc, row) => {
        const group = row[key];
        if (!acc[group]) {
          acc[group] = [];
        }
        acc[group].push(row);
        return acc;
      }, {});

    const renderCharts = () => {
      const cycleRows = state.filteredData.filter((row) => row.Unit === "Cycle Time");
      const laborRows = state.filteredData.filter((row) => row.Unit === "Labor Hours");
      const fteRows = state.filteredData.filter((row) => row.Unit === "FTE");

      const cycleByMachine = groupBy(cycleRows, "MachineType");
      const laborByMachine = groupBy(laborRows, "MachineType");
      const fteByMachine = groupBy(fteRows, "MachineType");

      const machineTypes = Array.from(
        new Set([
          ...Object.keys(cycleByMachine),
          ...Object.keys(laborByMachine),
          ...Object.keys(fteByMachine)
        ])
      ).sort();

      const cycleAverages = machineTypes.map((machine) =>
        calculateAverage((cycleByMachine[machine] || []).map((row) => row.Value))
      );

      const laborTotals = machineTypes.map((machine) =>
        (laborByMachine[machine] || []).reduce((total, row) => total + row.Value, 0)
      );

      const fteTotals = machineTypes.map((machine) =>
        (fteByMachine[machine] || []).reduce((total, row) => total + row.Value, 0)
      );

      const timeGroups = groupBy(cycleRows, "TimeApplicable");
      const timeLabels = Object.keys(timeGroups).sort((a, b) => {
        const [yearA, quarterA] = a.split("-Q");
        const [yearB, quarterB] = b.split("-Q");
        return Number(yearA) - Number(yearB) || Number(quarterA) - Number(quarterB);
      });
      const timeValues = timeLabels.map((label) =>
        calculateAverage(timeGroups[label].map((row) => row.Value))
      );

      if (state.charts.cycleByMachine) {
        Object.values(state.charts).forEach((chart) => chart.destroy());
      }

      state.charts.cycleByMachine = new Chart(
        document.getElementById("cycleByMachine"),
        {
          type: "bar",
          data: {
            labels: machineTypes,
            datasets: [
              {
                label: "Avg Cycle Time (sec)",
                data: cycleAverages,
                backgroundColor: palette.lightBlueFill,
                borderColor: palette.darkBlue,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                title: {
                  display: true,
                  text: "Seconds"
                }
              }
            }
          }
        }
      );

      state.charts.laborFteByMachine = new Chart(
        document.getElementById("laborFteByMachine"),
        {
          type: "bar",
          data: {
            labels: machineTypes,
            datasets: [
              {
                label: "Labor Hours",
                data: laborTotals,
                backgroundColor: palette.lightBlueFill,
                borderColor: palette.darkBlue,
                borderWidth: 1
              },
              {
                label: "FTE",
                data: fteTotals,
                backgroundColor: palette.lightBlueFill,
                borderColor: palette.darkBlue,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                title: {
                  display: true,
                  text: "Totals"
                }
              }
            }
          }
        }
      );

      state.charts.cycleOverTime = new Chart(
        document.getElementById("cycleOverTime"),
        {
          type: "line",
          data: {
            labels: timeLabels,
            datasets: [
              {
                label: "Avg Cycle Time (sec)",
                data: timeValues,
                borderColor: palette.darkBlue,
                backgroundColor: palette.lightBlueFillSoft,
                tension: 0.3,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                title: {
                  display: true,
                  text: "Seconds"
                }
              }
            }
          }
        }
      );
    };

    const renderTable = () => {
      if (!state.filteredData.length) {
        if (state.dataTable) {
          state.dataTable.clear().draw();
        }
        return;
      }

      const columns = Object.keys(state.filteredData[0]);
      elements.tableHead.innerHTML = "";
      elements.tableFoot.innerHTML = "";

      columns.forEach((column) => {
        const th = document.createElement("th");
        th.textContent = column;
        th.className = "px-3 py-2";
        elements.tableHead.appendChild(th);

        const footTh = document.createElement("th");
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `Search ${column}`;
        input.className =
          "w-full rounded-md border border-slate-200 px-2 py-1 text-xs text-slate-600 focus:border-[#76c7ff] focus:outline-none focus:ring-2 focus:ring-[#76c7ff]/40 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200";
        footTh.appendChild(input);
        footTh.className = "px-3 py-2";
        elements.tableFoot.appendChild(footTh);
      });

      if (state.dataTable) {
        state.dataTable.destroy();
      }

      state.dataTable = $("#dataTable").DataTable({
        data: state.filteredData,
        columns: columns.map((column) => ({ data: column })),
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        dom: "frtip",
        responsive: true
      });

      state.dataTable.columns().every(function () {
        const that = this;
        $("input", this.footer()).on("keyup change", function () {
          if (that.search() !== this.value) {
            that.search(this.value).draw();
          }
        });
      });
    };

    const refreshDashboard = async () => {
      await applyFilters();
      renderKPIs();
      renderCharts();
      renderTable();
    };

    const handleFileUpload = async (event) => {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      try {
        const text = await file.text();
        const parsed = await parseCsvAsync(text);
        await loadData(parsed);
      } catch (error) {
        alert("Unable to parse CSV file. Please check formatting.");
        console.error(error);
      }
    };

    const downloadFilteredCsv = () => {
      const csv = Papa.unparse(state.filteredData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "filtered-production-analytics.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    let scenarioIndex = 0;
    const updateRemoveButtons = () => {
      const rows = Array.from(elements.scenarioRows.querySelectorAll(".scenario-row"));
      rows.forEach((row, index) => {
        const removeButton = row.querySelector(".remove-scenario-row");
        if (!removeButton) {
          return;
        }
        if (index === 0 && rows.length === 1) {
          removeButton.classList.add("invisible");
          removeButton.setAttribute("aria-hidden", "true");
        } else {
          removeButton.classList.remove("invisible");
          removeButton.removeAttribute("aria-hidden");
        }
      });
    };

    const createScenarioRow = ({ units = baselineUnits, months = baselineMonths } = {}) => {
      scenarioIndex += 1;
      const row = document.createElement("div");
      row.className = "scenario-row grid gap-4 sm:grid-cols-[2fr_2fr_auto] items-end";

      const unitsId = `unitsInput-${scenarioIndex}`;
      const monthsId = `timeframeInput-${scenarioIndex}`;

      row.innerHTML = `
        <div>
          <label for="${unitsId}" class="text-sm font-medium text-slate-700 dark:text-slate-200">Units to build</label>
          <input
            id="${unitsId}"
            type="number"
            min="1"
            value="${units}"
            class="scenario-units mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-[#76c7ff] focus:outline-none focus:ring-2 focus:ring-[#76c7ff]/50 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200"
          />
        </div>
        <div>
          <label for="${monthsId}" class="text-sm font-medium text-slate-700 dark:text-slate-200">Time frame (months)</label>
          <input
            id="${monthsId}"
            type="number"
            min="1"
            value="${months}"
            class="scenario-months mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-[#76c7ff] focus:outline-none focus:ring-2 focus:ring-[#76c7ff]/50 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200"
          />
        </div>
        <div class="flex items-center gap-2">
          <button type="button" class="remove-scenario-row rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-500 transition hover:border-[#004a99] hover:text-[#004a99] dark:border-slate-600 dark:text-slate-300" aria-label="Remove this machine group">
            Remove
          </button>
        </div>
      `;

      elements.scenarioRows.appendChild(row);
      updateRemoveButtons();
    };

    const initializeScenarioRows = () => {
      elements.scenarioRows.innerHTML = "";
      scenarioIndex = 0;
      createScenarioRow();
    };

    const initializeFilters = () => {
      state.tomSelects.department = new TomSelect(elements.departmentFilter, {
        plugins: ["remove_button"],
        placeholder: "Select departments",
        onChange: () => refreshDashboard()
      });
      state.tomSelects.machine = new TomSelect(elements.machineFilter, {
        plugins: ["remove_button"],
        placeholder: "Select machine types",
        onChange: () => refreshDashboard()
      });
      state.tomSelects.dataset = new TomSelect(elements.datasetFilter, {
        plugins: ["remove_button"],
        placeholder: "Select datasets",
        onChange: () => refreshDashboard()
      });
    };

    const initialize = async () => {
      initializeScenarioRows();
      initializeFilters();

      const parsed = await parseCsvAsync(dummyCsv);
      await loadData(parsed);

      elements.criticalFilter.addEventListener("change", refreshDashboard);
      elements.csvFile.addEventListener("change", handleFileUpload);
      elements.downloadCsv.addEventListener("click", downloadFilteredCsv);
      elements.addScenarioRow.addEventListener("click", () => {
        createScenarioRow();
        refreshDashboard();
      });

      elements.scenarioRows.addEventListener("input", (event) => {
        if (event.target.matches(".scenario-units, .scenario-months")) {
          refreshDashboard();
        }
      });

      elements.scenarioRows.addEventListener("click", (event) => {
        if (!event.target.classList.contains("remove-scenario-row")) {
          return;
        }
        event.target.closest(".scenario-row").remove();
        updateRemoveButtons();
        refreshDashboard();
      });

      lucide.createIcons();
    };

    initialize();
  </script>
</body>
</html>
